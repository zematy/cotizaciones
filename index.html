<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Corporativo - Cpech</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerías PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.js"></script>
    <!-- Fuente Inter (Estándar Corporativo Moderno) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Inputs de Configuración */
        .form-label { display: block; font-size: 0.7rem; font-weight: 700; color: #475569; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; background-color: #fff; color: #1e293b; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #0f172a; ring: 1px solid #0f172a; }
        .form-select { cursor: pointer; }
        .subject-checkbox { accent-color: #0f172a; width: 16px; height: 16px; cursor: pointer; border-radius: 4px; }

        /* Contenedor PDF */
        #pdf-container { display: flex; flex-direction: column; gap: 40px; align-items: center; padding-bottom: 60px; }

        /* Hoja A4 */
        .pdf-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            color: #1e293b;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* --- ESTILOS PORTADA (Minimalista Ejecutivo) --- */
        #cover-page { display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .cover-accent { position: absolute; top: 0; left: 0; width: 100%; height: 12px; background-color: #0f172a; }
        .cover-content { padding: 80px 60px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .cover-bottom { padding: 40px 60px; }

        /* --- ESTILOS COTIZACIÓN (Ficha Técnica) --- */
        #quote-page { padding: 50px 60px; }
        
        .section-header { 
            border-bottom: 2px solid #0f172a; 
            margin-bottom: 20px; 
            padding-bottom: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: end;
        }
        .section-title { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #0f172a; }

        /* Ficha Técnica */
        .tech-sheet { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
        .tech-sheet td { padding: 10px 12px; border: 1px solid #e2e8f0; vertical-align: top; }
        .tech-sheet .label-col { background-color: #f8fafc; font-weight: 700; color: #475569; width: 28%; text-transform: uppercase; font-size: 10px; }
        .tech-sheet .value-col { color: #0f172a; font-weight: 500; }
        
        .tech-sheet .nested-label { font-size: 10px; font-weight: 700; color: #64748b; margin-top: 6px; margin-bottom: 2px; display: block; text-transform: uppercase; }
        .tech-sheet .nested-value { font-size: 11px; color: #0f172a; display: block; margin-bottom: 4px; padding-left: 0; }

        /* Tabla Económica */
        .econ-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        .econ-table th { background-color: #f1f5f9; color: #0f172a; text-align: left; padding: 10px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #cbd5e1; }
        .econ-table td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; }
        .econ-table tr:last-child td { border-bottom: 1px solid #cbd5e1; }

        .total-box { background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 4px; }
        
        /* Animaciones suaves */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col lg:flex-row overflow-hidden text-slate-800">

    <!-- SIDEBAR DE CONFIGURACIÓN -->
    <aside class="w-full lg:w-[420px] bg-white border-r border-gray-200 flex flex-col h-full overflow-y-auto z-20 shadow-xl scrollbar-thin">
        <div class="p-6 bg-slate-900 text-white sticky top-0 z-30 shadow-md">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold tracking-tight">Gestión de Convenios</h1>
                    <p class="text-[10px] text-slate-400 mt-0.5 uppercase tracking-wider font-medium">Cotizador Oficial V.Final</p>
                </div>
                <div class="h-8 w-8 bg-slate-800 rounded-full flex items-center justify-center text-xs font-bold text-slate-500">CP</div>
            </div>
        </div>

        <div class="p-6 space-y-8 flex-grow">
            
            <!-- 1. INSTITUCIÓN -->
            <div class="space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 flex items-center gap-2">
                    <span class="bg-slate-100 text-slate-500 w-5 h-5 flex items-center justify-center rounded-full text-[9px]">1</span> Institución
                </h3>
                <div><label class="form-label">Razón Social</label><input type="text" id="clientName" class="form-input" placeholder="Nombre del Colegio / Empresa" oninput="updatePreview()"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="form-label">RUT</label><input type="text" id="clientRut" class="form-input" placeholder="XX.XXX.XXX-X" oninput="updatePreview()"></div>
                    <div><label class="form-label">Fecha</label><input type="date" id="quoteDate" class="form-input" oninput="updatePreview()"></div>
                </div>
                <div><label class="form-label">Dirección</label><input type="text" id="clientAddress" class="form-input" placeholder="Dirección completa" oninput="updatePreview()"></div>
            </div>

            <!-- 2. PROGRAMA -->
            <div class="space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 flex items-center gap-2">
                    <span class="bg-slate-100 text-slate-500 w-5 h-5 flex items-center justify-center rounded-full text-[9px]">2</span> Programa Base
                </h3>
                <div>
                    <label class="form-label">Línea de Servicio</label>
                    <select id="lineSelect" class="form-input form-select" onchange="loadPrograms()">
                        <option value="" disabled selected>Seleccionar...</option>
                        <option value="linea1">Línea 1: Profesores cpech</option>
                        <option value="linea2">Línea 2: Apoyo Pedagógico (Recursos)</option>
                        <option value="linea3">Línea 3: Instrumentos de Evaluación</option>
                        <option value="linea4">Línea 4: Capacitaciones</option>
                    </select>
                </div>
                <div><label class="form-label">Programa</label><select id="programSelect" class="form-input bg-gray-50" disabled onchange="loadModalities()"><option value="">---</option></select></div>
                <div><label class="form-label">Modalidad</label><select id="modalitySelect" class="form-input bg-gray-50" disabled onchange="loadConfigurationSection()"><option value="">---</option></select></div>
            </div>
            
            <!-- 3. CONFIGURACIÓN TÉCNICA (RESTAURADO) -->
            <div id="config-container" class="bg-slate-50 p-5 rounded-lg border border-slate-200 hidden fade-in shadow-sm">
                <h3 class="text-xs font-black text-slate-800 mb-4 uppercase tracking-widest flex items-center gap-2">
                    <span class="bg-slate-800 text-white w-5 h-5 flex items-center justify-center rounded-full text-[9px]">3</span> Configuración Técnica
                </h3>

                <!-- Contenedor Genérico de Cursos (Para +Notas, +Orientados, Comprensión) -->
                <div id="config-course-selector" class="space-y-4 hidden">
                    <label id="course-selector-label" class="form-label text-blue-800">Cursos a cotizar</label>
                    <div id="course-selector-grid" class="grid grid-cols-2 gap-2 mt-1"></div>
                </div>

                <!-- PAES FULL (Docencia L1) / PAES RESOURCES (Material L2) -->
                <div id="config-paes-full" class="space-y-5 hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Dirigido a (Común para L1 y L2) -->
                        <div class="col-span-1">
                             <label class="form-label">Dirigido a</label>
                            <div id="paesTargetGrid" class="flex flex-col gap-2 mt-1 bg-white p-2 rounded border border-gray-200"></div>
                        </div>
                        <!-- Config Docencia (Solo L1) -->
                        <div id="paes-l1-docencia-config" class="space-y-3">
                            <div><label class="form-label">Plan</label><select id="paesPlan" class="form-input" onchange="updatePaesLogic()"><option value="Anual">Anual</option><option value="Intensivo">Intensivo</option></select></div>
                            <div>
                                <label class="form-label">Frecuencia Semanal (por asignatura)</label>
                                <select id="paesClassesPerWeek" class="form-input" onchange="updatePaesLogic()"><option value="1">1 Clase (80 min)</option><option value="2">2 Clases (160 min)</option></select>
                                <p id="paesClassesNote" class="text-[10px] text-orange-600 mt-1 hidden font-medium">Nota: 3° Medio tiene frecuencia fija de 1 clase/semana.</p>
                            </div>
                        </div>
                    </div>
                    <div id="paes-subjects-container" class="border-t border-gray-200 pt-4">
                        <label class="form-label text-slate-800 mb-2">Asignaturas a Incluir</label>
                        <div id="grid-subjects-3-container" class="hidden mb-3">
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-wider">3° Medio (PAES Básico)</p>
                            <div id="grid-subjects-3" class="grid grid-cols-1 gap-2 bg-white p-2 rounded border border-gray-200"></div>
                        </div>
                        <div id="grid-subjects-4-container" class="hidden">
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-wider">4° Medio / Egresados (PAES Completo)</p>
                            <div id="grid-subjects-4" class="grid grid-cols-2 gap-2 bg-white p-2 rounded border border-gray-200"></div>
                        </div>
                    </div>
                </div>

                <!-- +NOTAS Subjects Grid (Para +Notas, Líneas 1 y 2) -->
                <div id="config-notas-subjects-grid" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <p class="form-label mb-2">Asignaturas a Reforzar:</p>
                    <div id="notas-subjects-grid" class="grid grid-cols-1 gap-2"></div>
                </div>
                
                <!-- Nivelación/Libres (Solo Linea 1) -->
                <div id="config-nivelacion" class="space-y-3 hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">Duración</label><select id="nivelacionWeeks" class="form-input" onchange="updateSpecificDetails()"><option value="6">6 Semanas</option><option value="4">4 Semanas</option></select></div>
                        <div><label class="form-label">Frecuencia</label><select id="nivelacionClassesPerWeek" class="form-input" onchange="updateSpecificDetails()"><option value="1">1 Clase/sem</option><option value="2">2 Clases/sem</option></select></div>
                    </div>
                </div>
                <div id="config-examenes-libres" class="space-y-3 hidden">
                    <div><label class="form-label">Modalidad (Clases)</label><select id="libresModality" class="form-input" onchange="updateSpecificDetails()"><option value="Presencial">Presencial</option><option value="Online">Online</option></select></div>
                    <div><label class="form-label">Propósito</label><select id="libresPurpose" class="form-input" onchange="updateSpecificDetails()"><option value="Finalización de Estudios">Finalización de Estudios</option><option value="Fines Laborales">Fines Laborales</option></select></div>
                </div>
                <div id="hito-selector" class="hidden"><label class="form-label">N° Hitos / Ensayos</label><input type="number" id="hitosCount" value="1" min="1" max="15" class="form-input text-center font-bold" oninput="updateSpecificDetails()"></div>
                
            </div>
            <!-- FIN 3. CONFIGURACIÓN TÉCNICA -->

            <!-- 4. ECONÓMICO -->
            <div class="space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 flex items-center gap-2">
                    <span class="bg-slate-100 text-slate-500 w-5 h-5 flex items-center justify-center rounded-full text-[9px]">4</span> Económico
                </h3>
                
                <!-- Contenedor para inputs dinámicos por curso -->
                <div id="economics-container" class="space-y-3">
                    <!-- Se llena vía JS -->
                </div>
                
                <!-- Beca Manual / Editable -->
                <div id="beca-manual-container" class="hidden pt-3 border-t border-slate-100">
                    <label class="form-label text-blue-800">Detalle Beneficio Adicional (Editable)</label>
                    <textarea id="becaGlosa" class="form-input w-full h-20 text-xs resize-none" oninput="updatePreviewFromGlosa()" placeholder="Escriba aquí el detalle de la beca..."></textarea>
                    <p class="text-[9px] text-slate-400 mt-1">Este texto aparecerá en la ficha técnica.</p>
                </div>

                <!-- Selector de Formato (NUEVO) -->
                <div id="price-format-selector" class="pt-3 border-t border-slate-100 hidden fade-in">
                    <label class="form-label text-slate-800">Formato Visual de la Tabla Final</label>
                    <div class="flex space-x-4 mt-2 bg-slate-50 p-2 rounded border border-slate-200">
                        <div class="flex items-center">
                            <input type="radio" name="priceFormat" id="formatByCourse" value="course" class="subject-checkbox" checked onchange="updatePreview()">
                            <label for="formatByCourse" class="text-[10px] font-bold text-slate-700 ml-1.5 cursor-pointer">Detalle por Curso</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="priceFormat" id="formatTotal" value="total" class="subject-checkbox" onchange="updatePreview()">
                            <label for="formatTotal" class="text-[10px] font-bold text-slate-700 ml-1.5 cursor-pointer">Total Consolidado</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. PRECIO FINAL -->
            <div class="bg-slate-900 p-5 rounded-lg shadow-lg text-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-slate-300 uppercase">5. Valor Final (Neto)</h3>
                </div>
                <!-- CRÍTICO: El input es el master, editable, y muestra el resultado del auto-cálculo -->
                <input type="number" id="manualTotal" class="form-input text-2xl font-black text-slate-900 text-right h-14 border-none shadow-inner" value="0" oninput="updatePreviewFromManual()">
                <p id="total-summary-note" class="text-[10px] text-slate-400 mt-2 text-right italic hidden">Calculado para <span id="total-courses-count" class="font-bold text-white">1</span> curso(s).</p>
            </div>

        </div>

        <div class="p-6 bg-white border-t border-gray-200 sticky bottom-0 z-30">
            <button onclick="generatePDF()" id="btnDownload" class="w-full bg-slate-900 hover:bg-slate-800 text-white text-xs font-bold py-4 px-4 rounded shadow-xl transition transform hover:scale-[1.02] flex justify-center items-center gap-3 tracking-widest uppercase">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Generar PDF Oficial
            </button>
        </div>
    </aside>

    <!-- PREVIEW AREA -->
    <main class="w-full lg:w-auto flex-grow bg-slate-100 overflow-y-auto p-12 flex justify-center">
        
        <div id="pdf-container">
            <!-- PORTADA (Sin cambios) -->
            <div id="cover-page" class="pdf-page">
                <div class="cover-accent"></div>
                <div class="p-20 h-full flex flex-col justify-center relative">
                    <div class="absolute top-20 left-20">
                        <div class="text-3xl font-black text-slate-300 tracking-tighter">CPECH</div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Convenios Corporativos</div>
                    </div>
                    <div class="mb-24">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-[0.3em] mb-6">Propuesta de Servicios</p>
                        <h1 class="text-6xl font-black text-slate-900 leading-[1.1]" id="coverProgram">Programa Seleccionado</h1>
                        <p class="text-lg font-medium text-slate-700 mt-4 leading-tight" id="coverLineDesc">Descripción de la Línea de Servicio</p>
                        <div class="w-20 h-2 bg-slate-900 mt-8"></div>
                    </div>
                    <div class="border-l-4 border-slate-200 pl-8 py-4">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wide">Preparado exclusivamente para</p>
                        <h2 class="text-3xl font-bold text-slate-800" id="coverClientName">Institución Cliente</h2>
                        <p class="text-base text-slate-600 mt-1" id="coverClientAddress">Dirección Comercial</p>
                    </div>
                    <div class="absolute bottom-20 left-20 right-20 flex justify-between border-t border-slate-100 pt-8">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1 tracking-wider">Referencia</p>
                            <p class="text-sm font-mono text-slate-700 font-medium" id="coverRef">REF-000</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1 tracking-wider">Fecha de Emisión</p>
                            <p class="text-sm text-slate-700 font-medium" id="coverDate">DD/MM/AAAA</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COTIZACIÓN -->
            <div id="quote-page" class="pdf-page">
                <!-- Header -->
                <div class="flex justify-between items-start mb-12 pb-6 border-b border-slate-200">
                    <div>
                        <div class="text-2xl font-black text-slate-900 tracking-tighter">CPECH</div>
                    </div>
                    <div class="text-right">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em]">Cotización Formal</h2>
                        <p class="text-xs text-slate-500 mt-2 font-mono">REF: <span id="prevRef">000</span></p>
                    </div>
                </div>

                <!-- Intro / Cliente -->
                <div class="mb-12">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wide">Cliente</p>
                            <h3 class="text-xl font-bold text-slate-900" id="prevClientName">Nombre Cliente</h3>
                            <p class="text-xs text-slate-500 mt-1" id="prevClientRut">RUT</p>
                        </div>
                        <div class="text-right">
                             <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wide">Validez Oferta</p>
                             <p class="text-sm font-bold text-slate-900">30 Días</p>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 1: DETALLE TÉCNICO -->
                <div class="mb-12">
                    <div class="section-header">
                        <h3 class="section-title">Detalle del Programa</h3>
                    </div>
                    <div class="mb-4">
                        <h4 class="text-xl font-bold text-slate-900" id="detailProgramTitle">Programa</h4>
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mt-1" id="detailLineName">Línea</p>
                    </div>
                    <p class="text-xs text-justify leading-relaxed text-slate-600 mb-8 font-light" id="detailProgramDescription">
                        Descripción general...
                    </p>
                    <div id="detailSpecificsContainer"></div>

                    <!-- Beca (Manual/Editable en PDF) -->
                    <div id="beca-summary" class="hidden mt-6 p-4 bg-slate-50 border border-slate-200 text-xs text-slate-600 rounded-sm cursor-text hover:bg-slate-100 transition-colors" contenteditable="true">
                        <span class="font-bold text-slate-900 uppercase text-[10px] tracking-wide block mb-1">Beneficio Adicional</span>
                        <span id="beca-text-content">Incluye beca académica completa para 0 estudiantes.</span>
                    </div>
                </div>

                <!-- SECCIÓN 2: ECONÓMICO -->
                <div class="mb-16">
                    <div class="section-header">
                        <h3 class="section-title">Propuesta Económica</h3>
                    </div>
                    <table class="econ-table">
                        <thead>
                            <tr>
                                <th width="40%">Concepto</th>
                                <th width="20%">Modalidad</th>
                                <th width="10%" class="text-center">Cant.</th>
                                <th width="15%" class="text-right">Precio Unitario</th>
                                <th width="15%" class="text-right">Total Neto</th>
                            </tr>
                        </thead>
                        <tbody id="economic-table-body"></tbody>
                    </table>
                </div>

                <!-- TOTALES -->
                <div class="flex justify-end mb-20">
                    <div class="w-5/12 total-box">
                        <div class="flex justify-between items-end mb-3">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Total Neto a Pagar</span>
                            <span class="text-2xl font-black text-slate-900" id="prevFinalTotal">$0</span>
                        </div>
                        <div class="border-t border-slate-200 pt-3 text-right">
                            <span class="text-[10px] font-bold text-slate-900 uppercase tracking-wide bg-white px-2 py-1 rounded border border-slate-200">Valor Exento de IVA</span>
                            <p class="text-[9px] text-slate-400 mt-2 italic">* Valores expresados en Pesos Chilenos (CLP)</p>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="absolute bottom-12 left-12 right-12 border-t border-slate-200 pt-6">
                    <p class="text-[9px] text-slate-400 text-justify leading-relaxed">
                        <strong>Condiciones Generales:</strong> 1. Esta cotización está sujeta a disponibilidad. 2. Los materiales impresos (si aplica) serán entregados según cronograma. 3. Los servicios online requieren conexión estable. 4. Forma de pago según contrato. Documento confidencial propiedad de Cpech.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Definiciones de datos
        const COURSES = {'7° Básico':'7° Básico','8° Básico':'8° Básico','1° Medio':'1° Medio','2° Medio':'2° Medio','3° Medio':'3° Medio','4° Medio':'4° Medio','Egresados':'Egresados', 'General':'General'};
        const PAES_TARGET_COURSES = ['3° Medio', '4° Medio', 'Egresados'];
        const NOTAS_TARGET_COURSES = ['1° Medio', '2° Medio'];
        const NIVELACION_TARGET_COURSES = ['3° Medio', '4° Medio']; 
        const SUBJECTS = { 
            '1° Medio':['Matemática 1','Lenguaje','Cs. Naturales','Historia'], 
            '2° Medio':['Matemática 1','Lenguaje','Física','Química','Biología'], 
            '3° Medio_PAES':['Matemática 1 (M1)','Comprensión Lectora (CL)'], 
            '4° Medio_PAES':['Matemática 1 (M1)','Matemática 2 (M2)','Comprensión Lectora (CL)','Historia','Ciencias'] 
        };
        
        // Base de datos de Programas (Precios Unitarios por Modalidad)
        const db = {
            // LÍNEA 1: PROFESORES CPECH (DOCENCIA)
            "linea1": { 
                name: "Línea 1: Profesores cpech (Docencia)", 
                desc: "Docencia directa especializada. Servicios con profesores Cpech.", 
                programs: [
                    { name: "Programa PAES", configType: "paes-full", courses: PAES_TARGET_COURSES, prices: { "Online": 550000, "Presencial": 680000 }, details: "Programa integral de preparación académica con docencia Cpech." },
                    { name: "Programa +NOTAS", configType: "notas-full", courses: NOTAS_TARGET_COURSES, prices: { "Online": 150000, "Presencial": 210000 }, details: "Apoyo directo al rendimiento escolar (NEM) con docencia Cpech." },
                    { name: "Programa de Nivelación", configType: "nivelacion", courses: NIVELACION_TARGET_COURSES, prices: { "Online": 180000, "Presencial": 250000 }, details: "Refuerzo en contenidos fundamentales con docencia Cpech." },
                    { name: "Programa de Comprensión Lectora", configType: "comprension-lectora", courses: Object.keys(COURSES).filter(c=>!['Egresados', 'General'].includes(c)), fixedDetails: { duration: '15 Semanas', frequency: '1 Clase/sem (80 min)', plan: 'Anual' }, prices: { "Online": 110000, "Presencial": 140000 }, details: "Desarrollo profundo de habilidades lectoras con docencia Cpech." },
                    { name: "Programa +ORIENTADOS", configType: "orientados-full", courses: ['3° Medio', '4° Medio', 'Egresados'], prices: { "Online": 70000, "Presencial": 95000 }, details: "Módulos de orientación vocacional con docencia Cpech." },
                    { name: "Programa de Exámenes Libres", configType: "libres", courses: ['General'], prices: { "Online": 220000, "Presencial": 290000 }, details: "Preparación para validación de estudios con docencia Cpech." }
                ]
            },
            // LÍNEA 2: APOYO PEDAGÓGICO (RECURSOS)
            "linea2": { 
                name: "Línea 2: Apoyo Pedagógico (Recursos)", 
                desc: "Entrega de todos los recursos Cpech (físicos o digitales), pero con clases realizadas por profesionales del establecimiento contratante. El servicio se inicia con una inducción a los profesores del establecimiento respecto a los recursos, metodología y plan de trabajo.", 
                programs: [
                    { name: "Material PAES", configType: "paes-resources", courses: PAES_TARGET_COURSES, prices: { "Digital (Plataforma)": 350000, "Impreso (Físico)": 450000 }, details: "Set completo de recursos PAES (M1, M2, CL, Electivos) para 3° y 4° Medio/Egresados. Incluye inducción docente y derechos de uso anual." },
                    { name: "Material +ORIENTADOS", configType: "orientados-resources", courses: ['3° Medio', '4° Medio', 'Egresados'], prices: { "Digital (Plataforma)": 50000, "Impreso (Físico)": 75000 }, details: "Set de recursos vocacionales y de perfilación. Incluye inducción docente." },
                    { name: "Material +NOTAS", configType: "notas-resources", courses: NOTAS_TARGET_COURSES, prices: { "Digital (Plataforma)": 120000, "Impreso (Físico)": 180000 }, details: "Material didáctico de apoyo curricular para 1° y 2° Medio. Incluye inducción docente y derechos de uso anual." },
                    { name: "Programa de Orientación (Charla)", configType: "none", courses: ['1° Medio', '2° Medio', '3° Medio', '4° Medio', 'Egresados'], prices: { "Presencial (por Charla)": 150000, "Online (por Charla)": 110000 }, details: "Charlas y talleres vocacionales/académicos impartidos por Cpech. Precio por evento/sesión." }
                ]
            },
            // LÍNEA 3: Instrumentos de Evaluación
            "linea3": { 
                name: "Línea 3: Instrumentos de Evaluación", 
                desc: "Medición y diagnóstico. Aplicación de instrumentos Cpech con análisis de resultados.", 
                programs: [
                    { name: "Evaluaciones Curriculares", configType: "hitos", courses: Object.keys(COURSES).filter(c=>!['Egresados', 'General'].includes(c)), prices: { "Online": 68900 }, details: "Diagnóstico de cobertura curricular." },
                    { name: "Ensayos PAES", configType: "hitos", courses: ['3° Medio', '4° Medio', 'Egresados'], prices: { "Online": 103683, "Impresos": 117593 }, details: "Simulacros estandarizados con reporte de resultados por alumno." }
                ]
            },
            // LÍNEA 4: Capacitaciones
            "linea4": { 
                name: "Línea 4: Capacitaciones", 
                desc: "Formación docente y directiva especializada Cpech.", 
                programs: [
                    { name: "Taller Liderazgo", configType: "none", courses: ['Docentes', 'Directivos'], prices: { "Presencial": 500000, "Online": 400000 }, details: "Capacitación directiva y de gestión pedagógica. Precio por jornada completa." }
                ]
            }
        };

        const formatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
        let currentProgramConfig = null;

        function init() {
            document.getElementById('quoteDate').valueAsDate = new Date();
            // 1. Configuración de la grilla de selección de cursos PAES (solo una vez)
            setupPaesTargetGrid(); 
            // 2. Generar todos los posibles inputs económicos para todos los tipos de curso (solo una vez)
            generateEconomicInputs(Object.keys(COURSES).concat(['Docentes', 'Directivos'])); 
            updatePreview();
        }

        // --- MANEJO DE BECAS MANUALES ---
        function updateBecaLogic() {
            let totalBecas = 0;
            // Solo considerar inputs de beca de filas visibles
            const becaInputs = document.querySelectorAll('input[id^="becas_"]');
            becaInputs.forEach(input => {
                const parentRow = input.closest('div[id^="econ_row_"]');
                if (parentRow && !parentRow.classList.contains('hidden')) {
                     totalBecas += parseInt(input.value) || 0;
                }
            });

            const container = document.getElementById('beca-manual-container');
            const glosaInput = document.getElementById('becaGlosa');
            const summaryDiv = document.getElementById('beca-summary');
            const summaryText = document.getElementById('beca-text-content');

            if (totalBecas > 0) {
                container.classList.remove('hidden');
                summaryDiv.classList.remove('hidden');
                
                const defaultPattern = /^Incluye beneficio adicional para \d+ alumnos\/cursos.$/;
                if (glosaInput.value.trim() === '' || defaultPattern.test(glosaInput.value)) {
                    glosaInput.value = `Incluye beneficio adicional para ${totalBecas} alumnos/cursos.`;
                }
                
                summaryText.innerText = glosaInput.value;
            } else {
                container.classList.add('hidden');
                summaryDiv.classList.add('hidden');
                glosaInput.value = ''; // Resetear glosa al no haber becas
            }
        }

        function updatePreviewFromGlosa() {
            const glosa = document.getElementById('becaGlosa').value;
            const summaryText = document.getElementById('beca-text-content');
            if(summaryText) summaryText.innerText = glosa;
        }

        // --- GENERADORES DE CONTENIDO DINÁMICO ---
        
        // Genera todos los posibles inputs económicos, ocultos por defecto
        function generateEconomicInputs(courses) {
            const container = document.getElementById('economics-container');
            container.innerHTML = '';
            const uniqueCourses = [...new Set(courses)];

            uniqueCourses.forEach((course) => {
                const id = course.replace(/[^a-zA-Z0-9]/g, '');
                const row = document.createElement('div');
                row.className = "bg-white p-2.5 rounded border border-gray-200 text-xs hidden"; 
                row.id = `econ_row_${id}`;
                row.innerHTML = `
                    <p class="font-bold text-slate-800 mb-2 border-b border-gray-100 pb-1">${course}</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase">Pagando (Cant.)</label>
                            <input type="number" id="students_${id}" data-course="${course}" value="0" min="0" class="form-input text-xs font-bold h-8 w-full" oninput="toggleEconomicInputs()">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-blue-500 uppercase">Beneficio (Cant.)</label>
                            <input type="number" id="becas_${id}" data-course="${course}" value="0" min="0" class="form-input text-xs text-blue-600 h-8 w-full" oninput="toggleEconomicInputs()">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-slate-800 uppercase">Precio Unitario Neto</label>
                            <input type="number" id="unitPrice_${id}" data-course="${course}" value="0" min="0" class="form-input text-xs font-bold h-8 w-full text-right" oninput="toggleEconomicInputs()">
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            toggleEconomicInputs();
        }

        // Genera la grilla de selección de cursos PAES (solo una vez)
        function setupPaesTargetGrid() {
            const grid = document.getElementById('paesTargetGrid');
            grid.innerHTML = '';
            const targetCourses = PAES_TARGET_COURSES;
            targetCourses.forEach((course) => {
                const id = `paes_target_${course.replace(/[^a-zA-Z0-9]/g, '')}`;
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                // PAES: 4° Medio y Egresados se marcan por defecto
                const isChecked = course.includes('4°') || course.includes('Egresados'); 
                div.innerHTML = `<input type="checkbox" id="${id}" value="${course}" class="subject-checkbox" onchange="updatePaesLogic()" ${isChecked ? 'checked' : ''}> <label for="${id}" class="text-[11px] text-slate-700 cursor-pointer font-medium">${course}</label>`;
                grid.appendChild(div);
            });
            // Generar las grillas de asignaturas, pero ocultas por defecto
            generateSubjectGrid('grid-subjects-3', SUBJECTS['3° Medio_PAES'], 'sP3', '3° Medio'); 
            generateSubjectGrid('grid-subjects-4', SUBJECTS['4° Medio_PAES'], 'sP4', '4° Medio/Egresados'); 
        }

        // Genera una grilla genérica de asignaturas (usada por PAES y +NOTAS)
        function generateSubjectGrid(containerId, list, prefix, course) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            list.forEach((sub, i) => {
                const id = `${prefix}_${course.replace(/[^a-zA-Z0-9]/g, '')}_${i}`;
                const div = document.createElement('div');
                div.className = 'flex items-start space-x-2';
                div.innerHTML = `<input type="checkbox" id="${id}" value="${sub}" data-course="${course}" class="subject-checkbox mt-0.5" onchange="updateSpecificDetails()"> <label for="${id}" class="text-[11px] text-slate-700 cursor-pointer leading-tight">${sub}</label>`;
                container.appendChild(div);
            });
        }
        
        // Genera la grilla de selección de cursos (+NOTAS, +ORIENTADOS, Comp. Lectora, Nivelación, Hitos)
        function generateCourseGrid(containerId, list, prefix, onChangeFunc) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            list.forEach((course) => {
                const id = `${prefix}_${course.replace(/[^a-zA-Z0-9]/g, '')}`;
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 bg-white p-1 rounded border border-gray-100';
                
                const isChecked = false; 
                
                div.innerHTML = `<input type="checkbox" id="${id}" value="${course}" class="subject-checkbox" onchange="${onChangeFunc}()" ${isChecked ? 'checked' : ''}> <label for="${id}" class="text-[11px] text-slate-700 cursor-pointer font-medium">${course}</label>`;
                container.appendChild(div);
            });
        }
        
        // --- LÓGICA DE SELECCIÓN DE PROGRAMA (PASO 2) ---

        function loadPrograms() {
            const line = document.getElementById('lineSelect').value;
            const progSel = document.getElementById('programSelect');
            const modSel = document.getElementById('modalitySelect');
            
            progSel.innerHTML = '<option value="">---</option>'; modSel.innerHTML = '<option value="">---</option>';
            progSel.disabled = true; modSel.disabled = true;
            hideAllConfigs();
            currentProgramConfig = null;

            if (line && db[line]) {
                progSel.disabled = false;
                db[line].programs.forEach((p, i) => progSel.add(new Option(p.name, i)));
                setText('coverLineDesc', db[line].desc); 
            }
            updatePreview();
        }

        function loadModalities() {
            const line = document.getElementById('lineSelect').value;
            const progIdx = document.getElementById('programSelect').value;
            const modSel = document.getElementById('modalitySelect');
            
            modSel.innerHTML = '<option value="">---</option>'; modSel.disabled = true;
            hideAllConfigs();

            if (line && progIdx !== "") {
                const prog = db[line].programs[progIdx];
                currentProgramConfig = prog;
                if (Object.keys(prog.prices).length > 0) {
                     modSel.disabled = false;
                     // El valor de la opción es el precio base sugerido, el texto es la modalidad
                     for (let [k, v] of Object.entries(prog.prices)) modSel.add(new Option(k, v));
                } else {
                     modSel.add(new Option("N/A", 0));
                }
                setText('prevProgram', prog.name);
                setText('coverProgram', prog.name);
                setText('detailProgramTitle', prog.name);
                setText('detailLineName', db[line].name);
                setText('detailProgramDescription', prog.details);
                setText('coverLineDesc', db[line].desc);
            }
        }

        // Oculta todas las secciones de configuración (Paso 3) y resetea inputs económicos
        function hideAllConfigs() {
            document.getElementById('config-container').classList.add('hidden');
            document.getElementById('price-format-selector').classList.add('hidden');
            const sections = ['config-paes-full', 'config-course-selector', 'config-notas-subjects-grid', 'config-nivelacion', 'config-examenes-libres', 'hito-selector'];
            sections.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('paes-l1-docencia-config').classList.add('hidden'); 
            
            // Ocultar todos los inputs económicos y resetear estudiantes, becas y precio unitario
            document.querySelectorAll('#economics-container > div').forEach(row => {
                row.classList.add('hidden');
                const studentInput = row.querySelector('input[id^="students_"]');
                const becaInput = row.querySelector('input[id^="becas_"]');
                const priceInput = row.querySelector('input[id^="unitPrice_"]'); // Nuevo input
                if (studentInput) studentInput.value = 0; 
                if (becaInput) becaInput.value = 0;      
                if (priceInput) priceInput.value = 0; // Resetear precio unitario
            });
            document.getElementById('beca-manual-container').classList.add('hidden'); 
            
            autoCalculate(); // Recalcular con todo oculto
        }

        // CRÍTICO: Carga el contenido dinámico del Paso 3 según el programa seleccionado
        function loadConfigurationSection() {
            // VERIFICACIÓN CRÍTICA: Solo continuar si hay programa Y modalidad seleccionados
            if (!currentProgramConfig || !document.getElementById('modalitySelect').value) {
                hideAllConfigs();
                return;
            }
            const prog = currentProgramConfig;
            
            hideAllConfigs(); // Empezar limpio
            document.getElementById('config-container').classList.remove('hidden');
            
            // Mostrar secciones según tipo de programa
            
            // PAES (L1 y L2)
            if (prog.configType === 'paes-full' || prog.configType === 'paes-resources') {
                document.getElementById('config-paes-full').classList.remove('hidden');
                if (prog.configType === 'paes-full') {
                    document.getElementById('paes-l1-docencia-config').classList.remove('hidden'); 
                }
                updatePaesLogic(); // Cargar la lógica de asignaturas PAES
            // +NOTAS (L1 y L2)
            } else if (prog.configType === 'notas-full' || prog.configType === 'notas-resources') { 
                const titleMap = { 'notas-full': 'Cursos +NOTAS Docencia', 'notas-resources': 'Cursos +NOTAS Material' };
                setText('course-selector-label', titleMap[prog.configType]);
                generateCourseGrid('course-selector-grid', prog.courses, 'course', 'updateNotasSubjects'); // Generar selector de cursos 1°/2° Medio
                document.getElementById('config-course-selector').classList.remove('hidden');
                document.getElementById('config-notas-subjects-grid').classList.remove('hidden');
                updateNotasSubjects(); // Cargar la grilla de asignaturas +NOTAS (que aparecerá/desaparecerá)
            // +ORIENTADOS, Comprensión Lectora (L1 y L2)
            } else if (prog.configType === 'orientados-full' || prog.configType === 'orientados-resources' || prog.configType === 'comprension-lectora') { 
                const titleMap = { 'orientados-full': 'Cursos +ORIENTADOS Docencia', 'orientados-resources': 'Cursos +ORIENTADOS Material', 'comprension-lectora': 'Cursos Comp. Lectora' };
                setText('course-selector-label', titleMap[prog.configType]);
                generateCourseGrid('course-selector-grid', prog.courses, 'course', 'updateSpecificDetails');
                document.getElementById('config-course-selector').classList.remove('hidden');
            // Nivelación (L1)
            } else if (prog.configType === 'nivelacion') { 
                document.getElementById('config-nivelacion').classList.remove('hidden');
                // Nivelación usa los mismos inputs que la grilla de cursos
                generateCourseGrid('course-selector-grid', prog.courses, 'course', 'updateSpecificDetails');
                document.getElementById('config-course-selector').classList.remove('hidden');
                setText('course-selector-label', 'Cursos a Nivelar');
            // Exámenes Libres (L1)
            } else if (prog.configType === 'libres') { 
                document.getElementById('config-examenes-libres').classList.remove('hidden');
                // Ajuste: Para Libres, no se necesita el selector de cursos, solo el input económico 'General'
                document.getElementById('config-course-selector').classList.add('hidden');
                // Asegurar que el input 'General' esté visible para cotizar el programa
                document.getElementById('econ_row_General')?.classList.remove('hidden');
            // Hitos/Ensayos (L3)
            } else if (prog.configType === 'hitos') { 
                document.getElementById('hito-selector').classList.remove('hidden');
                generateCourseGrid('course-selector-grid', prog.courses, 'course', 'updateSpecificDetails');
                document.getElementById('config-course-selector').classList.remove('hidden');
                setText('course-selector-label', 'Cursos a Evaluar');
            // Charla L2, Capacitación L4 (Sin configuración adicional)
            } else if (prog.configType === 'none') {
                 // Si no tiene configuración, ocultamos el Paso 3
                 document.getElementById('config-container').classList.add('hidden');
                 // Para 'none', usamos el primer curso (Docentes/Directivos/etc.)
                 if (prog.courses.length > 0) {
                    const courseId = prog.courses[0].replace(/[^a-zA-Z0-9]/g, '');
                    document.getElementById(`econ_row_${courseId}`)?.classList.remove('hidden');
                 }
            }

            // Determinar si se usa el selector de formato económico
            const isMultiSelectable = prog.configType.includes('full') || prog.configType.includes('resources') || prog.configType === 'hitos' || prog.configType === 'nivelacion' || prog.configType === 'comprension-lectora' || prog.configType === 'orientados-full';
            document.getElementById('price-format-selector').classList.toggle('hidden', !isMultiSelectable);
            
            // Actualizar inputs económicos y detalles finales
            toggleEconomicInputs();
            updateSpecificDetails();
        }

        // Lógica de Asignaturas para PAES (3°/4°/Egresados)
        function updatePaesLogic() {
            const selectedTargets = getCheckedValues('paesTargetGrid');
            const cont3 = document.getElementById('grid-subjects-3-container');
            const cont4 = document.getElementById('grid-subjects-4-container');
            const includes3rd = selectedTargets.includes('3° Medio');
            const includes4thOrEgresados = selectedTargets.includes('4° Medio') || selectedTargets.includes('Egresados');

            // Lógica de L1 (Docencia) para la nota de la frecuencia
            const isDocencia = currentProgramConfig?.configType === 'paes-full';
            document.getElementById('paesClassesNote').classList.toggle('hidden', !isDocencia || !includes3rd);

            // Mostrar/Ocultar contenedores de asignaturas
            cont3.classList.add('hidden'); cont4.classList.add('hidden');
            if (includes3rd) cont3.classList.remove('hidden');
            if (includes4thOrEgresados) cont4.classList.remove('hidden');
            
            updateSpecificDetails();
        }

        // Lógica de Asignaturas para +NOTAS (1°/2° Medio)
        function updateNotasSubjects() {
            const selectedCourses = getCheckedValues('course-selector-grid');
            const subjectContainer = document.getElementById('notas-subjects-grid');
            subjectContainer.innerHTML = '';
            
            selectedCourses.forEach(course => {
                // Solo cargar asignaturas para 1° y 2° Medio, si están en SUBJECTS
                if (SUBJECTS[course]) { 
                    const header = document.createElement('div');
                    header.className = 'text-[10px] font-bold text-blue-700 mt-2 mb-1 uppercase tracking-wide';
                    header.innerText = course;
                    subjectContainer.appendChild(header);
                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'grid grid-cols-2 gap-2 bg-white p-2 rounded border border-gray-100 mb-1';
                    SUBJECTS[course].forEach((sub, i) => {
                        const id = `sN_${course.replace(/[^a-zA-Z0-9]/g, '')}_${i}`;
                        const div = document.createElement('div');
                        div.className = 'flex items-center space-x-2';
                        // CRÍTICO: Asignaturas deben empezar desmarcadas
                        const isChecked = false; 
                        div.innerHTML = `<input type="checkbox" id="${id}" value="${sub}" data-course="${course}" class="subject-checkbox" onchange="updateSpecificDetails()" ${isChecked ? 'checked' : ''}> <label for="${id}" class="text-[11px] text-slate-700 cursor-pointer">${sub}</label>`;
                        gridDiv.appendChild(div);
                    });
                    subjectContainer.appendChild(gridDiv);
                }
            });
            updateSpecificDetails();
        }
        
        // Función genérica que actualiza los detalles técnicos en el PDF (Ficha Técnica)
        function updateSpecificDetails() {
            if (!currentProgramConfig) return;
            const prog = currentProgramConfig;
            const container = document.getElementById('detailSpecificsContainer');
            let rows = "";
            let selectedCourses = [];
            
            // 1. Determinar cursos/alcance seleccionado (Mismo proceso que en toggleEconomicInputs)
            const configType = prog.configType;

            if (['notas-full', 'comprension-lectora', 'orientados-full', 'notas-resources', 'orientados-resources', 'nivelacion', 'hitos'].includes(configType)) {
                 selectedCourses = getCheckedValues('course-selector-grid');
            } else if (['paes-full', 'paes-resources'].includes(configType)) {
                 selectedCourses = getCheckedValues('paesTargetGrid');
            } else if (configType === 'libres') {
                 // Ajuste para Exámenes Libres: no hay selector de cursos, el alcance es fijo
                 selectedCourses = ['General'];
            } else {
                 selectedCourses = prog.courses || [];
            }
            
            toggleEconomicInputs(); // Vuelve a asegurar que los inputs económicos coincidan con los cursos seleccionados
            
            // 2. RECUPERAR PRECIO BASE SUGERIDO
            const suggestedPrice = parseFloat(document.getElementById('modalitySelect').value) || 0;

            // 3. Establecer el precio base en los campos unitarios activos si están a 0
            selectedCourses.forEach(course => {
                const id = course.replace(/[^a-zA-Z0-9]/g, '');
                const priceInput = document.getElementById(`unitPrice_${id}`);
                // Si el precio base sugerido es > 0, y el campo manual está en 0, lo actualiza.
                if (priceInput && parseFloat(priceInput.value) === 0 && suggestedPrice > 0) {
                     priceInput.value = suggestedPrice;
                }
            });


            // 4. FICHA TÉCNICA
            let coursesForRow = 'N/A';
            if (configType === 'libres') {
                coursesForRow = 'Personas que buscan Finalización de Estudios / Fines Laborales.';
            } else if (configType === 'none' && prog.courses.length > 0) {
                 coursesForRow = prog.courses.join(', '); // Docentes/Directivos
            } else {
                coursesForRow = (selectedCourses.join(', ') || 'N/A');
            }
            
            // FILA DE ALCANCE (Solo si no es 'none' o 'libres' que tienen textos especiales)
            if (configType !== 'none' && configType !== 'libres') {
                 rows += createRow(configType.includes('paes') ? 'Dirigido a' : 'Alcance', coursesForRow);
            }


            // AGREGAR MODALIDAD Y DETALLES ESPECÍFICOS
            const modalitySelect = document.getElementById('modalitySelect');
            const modalityText = modalitySelect.options[modalitySelect.selectedIndex]?.text || "No Definida";
            const isDocencia = prog.configType.includes('full') || prog.configType === 'nivelacion' || prog.configType === 'libres' || prog.configType === 'comprension-lectora';
            const isRecursos = prog.configType.includes('resources');

            if (isRecursos) {
                 rows += createRow('Tipo de Entrega', modalityText);
                 rows += createRow('Servicio Incluido', 'Inducción Docente y Derechos de Uso Anual');
            } else if (prog.configType === 'libres') {
                 rows += createRow('Público Objetivo', coursesForRow); // Usar el texto 'Personas...'
                 rows += createRow('Propósito', document.getElementById('libresPurpose').value);
                 rows += createRow('Modalidad (Clases)', document.getElementById('libresModality').value); 
            } else if (prog.configType === 'hitos') {
                 rows += createRow('Modalidad', modalityText);
                 rows += createRow('N° Hitos / Ensayos', document.getElementById('hitosCount').value);
            } else if (prog.configType === 'none') { // Charla L2, Capacitación L4
                 rows += createRow('Público Objetivo', coursesForRow);
                 rows += createRow('Modalidad', modalityText);
                 rows += createRow('Servicio', prog.name);
            } else if (isDocencia) {
                 rows += createRow('Modalidad', modalityText);
            }
            
            // Lógica de Asignaturas/Frecuencia
            if (prog.configType === 'paes-full') {
                const plan = document.getElementById('paesPlan').value;
                const freq = document.getElementById('paesClassesPerWeek').value;
                rows += createRow('Plan', plan);
                rows += createRow('Frecuencia', freq + " Clase(s)/sem (80 min)");
                const s3 = getCheckedSubjectsGrouped('grid-subjects-3');
                const s4eg = getCheckedSubjectsGrouped('grid-subjects-4'); 
                let subjectContent = '';
                if (selectedCourses.includes('3° Medio')) subjectContent += `<span class="nested-label">3° Medio (PAES Básico)</span><span class="nested-value">${s3.length > 0 ? s3.join(', ') : 'Ninguna'}</span>`;
                if (selectedCourses.includes('4° Medio') || selectedCourses.includes('Egresados')) subjectContent += `<span class="nested-label">4°/Egresados (PAES Completo)</span><span class="nested-value">${s4eg.length > 0 ? s4eg.join(', ') : 'Ninguna'}</span>`;
                rows += createRow('Asignaturas', subjectContent || 'Ninguna', true);
            } else if (prog.configType === 'paes-resources') {
                const s3 = getCheckedSubjectsGrouped('grid-subjects-3');
                const s4eg = getCheckedSubjectsGrouped('grid-subjects-4'); 
                let subjectContent = '';
                if (selectedCourses.includes('3° Medio')) subjectContent += `<span class="nested-label">3° Medio (PAES Básico)</span><span class="nested-value">${s3.length > 0 ? s3.join(', ') : 'Ninguna'}</span>`;
                if (selectedCourses.includes('4° Medio') || selectedCourses.includes('Egresados')) subjectContent += `<span class="nested-label">4°/Egresados (PAES Completo)</span><span class="nested-value">${s4eg.length > 0 ? s4eg.join(', ') : 'Ninguna'}</span>`;
                rows += createRow('Recursos Adquiridos', subjectContent || 'Ninguno', true);
            } else if (prog.configType === 'notas-full' || prog.configType === 'notas-resources') {
                rows += createRow('Duración', 'Anual');
                const selectedSubjects = getCheckedSubjectsByCourse('notas-subjects-grid');
                let subjectContent = '';
                selectedCourses.forEach(course => {
                    const subs = selectedSubjects[course] || [];
                    if (subs.length > 0) subjectContent += `<span class="nested-label">${course}</span><span class="nested-value">${subs.join(', ')}</span>`;
                });
                rows += createRow(prog.configType === 'notas-full' ? 'Asignaturas' : 'Recursos Adquiridos', subjectContent || 'Ninguno', true);
            } else if (prog.configType === 'comprension-lectora') {
                rows += createRow('Duración', prog.fixedDetails.duration);
                rows += createRow('Frecuencia', prog.fixedDetails.frequency);
            } else if (prog.configType === 'nivelacion') {
                rows += createRow('Duración', document.getElementById('nivelacionWeeks').value + " Semanas");
                rows += createRow('Intensidad', document.getElementById('nivelacionClassesPerWeek').value + " Clases/sem");
            } 

            container.innerHTML = `<table class="tech-sheet"><tbody>${rows}</tbody></table>`;
            
            updateBecaLogic(); 
        }

        // --- FUNCIONES UTILITY ---

        function getCheckedValues(containerId) {
            return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(cb => cb.value);
        }
        function setText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        function createRow(label, value, isNested = false) { 
            return `<tr><td class="label-col">${label}</td><td class="value-col">${value}</td></tr>`;
        }
        function getCheckedSubjectsGrouped(gridId) { return Array.from(document.querySelectorAll(`#${gridId} input:checked`)).map(cb => cb.value); }
        function getCheckedSubjectsByCourse(gridId) {
            const selected = {};
            Array.from(document.querySelectorAll(`#${gridId} input[type="checkbox"]:checked`)).forEach(cb => {
                const course = cb.dataset.course;
                if (!selected[course]) selected[course] = [];
                selected[course].push(cb.value);
            });
            return selected;
        }

        // --- LÓGICA ECONÓMICA (PASO 4 & 5) ---

        // CRÍTICO: Muestra/Oculta los inputs económicos y dispara el cálculo
        function toggleEconomicInputs() {
            if (!currentProgramConfig) return;
            
            let selectedCourses = [];
            const configType = currentProgramConfig.configType;

            // 1. Determinar qué inputs económicos deben estar activos
            if (['notas-full', 'comprension-lectora', 'orientados-full', 'notas-resources', 'orientados-resources', 'nivelacion', 'hitos'].includes(configType)) {
                 selectedCourses = getCheckedValues('course-selector-grid');
            } else if (['paes-full', 'paes-resources'].includes(configType)) {
                 selectedCourses = getCheckedValues('paesTargetGrid');
            } else if (configType === 'libres' || configType === 'none') {
                 // Para programas sin selector de curso (Libres, Charla, Cap.), usamos la lista base
                 selectedCourses = currentProgramConfig.courses; 
            } else {
                 selectedCourses = currentProgramConfig.courses || [];
            }
            
            // 2. Mapear y controlar la visibilidad de los inputs económicos
            const allEconRows = document.querySelectorAll('#economics-container > div');
            
            const validCourseNames = Array.isArray(selectedCourses) ? selectedCourses : [selectedCourses];
            const activeCoursesIds = validCourseNames.map(c => c.replace(/[^a-zA-Z0-9]/g, ''));

            let totalActiveCourses = 0;
            allEconRows.forEach(row => {
                const studentInput = row.querySelector('input[id^="students_"]');
                const priceInput = row.querySelector('input[id^="unitPrice_"]'); // Nuevo input
                if (studentInput) {
                    const courseName = studentInput.dataset.course;
                    const courseId = courseName.replace(/[^a-zA-Z0-9]/g, '');
                    
                    const isVisible = activeCoursesIds.includes(courseId);

                    row.classList.toggle('hidden', !isVisible);
                    
                    if (isVisible) {
                        totalActiveCourses++;
                    } else {
                        // Resetear valores de inputs ocultos para que no coticen
                        studentInput.value = 0;
                        const becaInput = row.querySelector('input[id^="becas_"]');
                        if (becaInput) becaInput.value = 0;
                        if (priceInput) priceInput.value = 0; // Resetear precio unitario
                    }
                }
            });

            // 3. Actualizar resumen y calcular
            document.getElementById('total-courses-count').innerText = totalActiveCourses;
            document.getElementById('total-summary-note').classList.toggle('hidden', totalActiveCourses <= 1);
            autoCalculate();
        }

        function autoCalculate() {
            let totalNeto = 0;
            const activeEconRows = document.querySelectorAll('#economics-container > div:not(.hidden)');
            
            // Recalcular total neto basado en el precio unitario * estudiantes pagando en filas activas
            activeEconRows.forEach(row => {
                const courseId = row.id.replace('econ_row_', '');
                const studentsPagando = parseInt(document.getElementById(`students_${courseId}`).value) || 0;
                const unitPrice = parseFloat(document.getElementById(`unitPrice_${courseId}`).value) || 0;
                
                totalNeto += unitPrice * studentsPagando;
            });

            document.getElementById('manualTotal').value = totalNeto;
            updatePreviewFromManual();
            updateBecaLogic(); 
        }

        function updatePreviewFromManual() {
            const val = parseFloat(document.getElementById('manualTotal').value) || 0;
            setText('prevFinalTotal', formatter.format(val));
            updatePreview();
        }

        // --- GENERACIÓN DE PDF Y VISTA PREVIA ---
        
        function updatePreview() {
            const fields = ['clientName', 'clientRut', 'clientAddress'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    const val = el.value;
                    setText('prev' + capitalize(id), val);
                    setText('cover' + capitalize(id), val);
                }
            });
            const date = document.getElementById('quoteDate').value;
            if(date) {
                const [y,m,d] = date.split('-');
                const fmt = `${d}/${m}/${y}`;
                // Genera referencia única basada en fecha y un número aleatorio
                const ref = `CPEC-2025-${m}${d}${Math.floor(Math.random()*900) + 100}`; 
                setText('prevDate', fmt); setText('coverDate', fmt);
                setText('prevRef', ref); setText('coverRef', ref);
            }
            updateEconomicTable();
        }

        function updateEconomicTable() {
            const tableBody = document.getElementById('economic-table-body');
            tableBody.innerHTML = '';
            const progName = document.getElementById('programSelect').options[document.getElementById('programSelect').selectedIndex]?.text || "Programa";
            const modSelect = document.getElementById('modalitySelect');
            const modText = modSelect.options[modSelect.selectedIndex]?.text || "-"; 
            const finalTotal = parseFloat(document.getElementById('manualTotal').value) || 0;

            
            // Leer inputs activos (visibles y con cantidad total > 0)
            const activeEconRows = document.querySelectorAll('#economics-container > div:not(.hidden)');
            
            const detailedItems = [];
            let totalStudents = 0;
            
            activeEconRows.forEach(row => {
                const courseId = row.id.replace('econ_row_', '');
                const course = document.getElementById(`students_${courseId}`).dataset.course;

                const studentsPagando = parseInt(document.getElementById(`students_${courseId}`).value) || 0;
                const becas = parseInt(document.getElementById(`becas_${courseId}`).value) || 0;
                const unitPrice = parseFloat(document.getElementById(`unitPrice_${courseId}`).value) || 0; // Precio Unitario Manual

                const quotedStudents = studentsPagando + becas;

                if (quotedStudents > 0) {
                    const courseTotal = unitPrice * studentsPagando; // El total es solo la parte pagada
                    detailedItems.push({ course, students: quotedStudents, studentsPagando, unitPrice, total: courseTotal });
                    totalStudents += quotedStudents;
                }
            });
            
            const isMulti = detailedItems.length > 1;
            // CRÍTICO: Lógica de selección del radio button
            const isDetail = document.getElementById('formatByCourse').checked;
            
            if (isDetail && isMulti) {
                // Mostrar detalle por curso
                detailedItems.forEach(item => {
                    const glosa = item.studentsPagando < item.students ? ` (${item.students - item.studentsPagando} c/Beca)` : '';
                    let itemConcept = `${progName} - ${item.course}`;
                    if(item.course === 'General' || item.course === 'Docentes' || item.course === 'Directivos') itemConcept = progName; 
                    
                    tableBody.innerHTML += `<tr><td><span class="font-bold text-slate-900 block">${itemConcept}${glosa}</span></td><td class="text-slate-600">${modText}</td><td class="text-center font-bold">${item.students}</td><td class="text-right">${formatter.format(item.unitPrice)}</td><td class="text-right font-bold text-slate-900">${formatter.format(item.total)}</td></tr>`;
                });
            } else {
                // Mostrar total consolidado (o si solo hay un item)
                const totalPagando = detailedItems.reduce((sum, item) => sum + item.studentsPagando, 0);
                const totalBecas = totalStudents - totalPagando;
                const glosaTotal = totalBecas > 0 ? ` (Incluye ${totalBecas} c/Beca)` : '';

                const totalItemName = isMulti ? `${progName} (Consolidado - ${detailedItems.length} Alcances)` : progName;

                let cantDisplay = totalStudents;
                let unitPriceDisplay = totalPagando > 0 ? (finalTotal / totalPagando) : 0;
                
                // Si es un programa single-target (Libres, Charla, Cap), la cantidad y precio unitario son del ítem único.
                if (detailedItems.length === 1) {
                    cantDisplay = detailedItems[0].students;
                    unitPriceDisplay = detailedItems[0].unitPrice;
                } else if (totalStudents === 0) {
                    unitPriceDisplay = 0;
                }
                
                // Asegurar que no se muestre NaN o Infinity si totalPagando es 0
                const unitPriceText = unitPriceDisplay > 0 ? formatter.format(unitPriceDisplay) : 'N/A';
                
                // Si el formato es consolidado, o si solo hay 1 ítem, usamos la vista consolidada.
                tableBody.innerHTML = `<tr><td><span class="font-bold text-slate-900 block">${totalItemName}${glosaTotal}</span></td><td class="text-slate-600">${modText}</td><td class="text-center font-bold">${cantDisplay}</td><td class="text-right text-slate-600">${unitPriceText}</td><td class="text-right font-bold text-slate-900">${formatter.format(finalTotal)}</td></tr>`;
            }

            if (detailedItems.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-slate-400 italic">No hay programas o cursos seleccionados para cotizar.</td></tr>`;
            }
        }


        async function generatePDF() {
            const btn = document.getElementById('btnDownload');
            btn.innerHTML = 'Generando...'; btn.disabled = true;
            const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
            const w = pdf.internal.pageSize.getWidth();
            const addPage = async (id, isFirst) => {
                if(!isFirst) pdf.addPage();
                const cvs = await html2canvas(document.getElementById(id), { scale: 2, useCORS: true });
                const img = cvs.toDataURL('image/jpeg', 0.95);
                const props = pdf.getImageProperties(img);
                const h = (props.height * w) / props.width;
                pdf.addImage(img, 'JPEG', 0, 0, w, h);
            };
            await addPage('cover-page', true);
            await addPage('quote-page', false);
            const name = document.getElementById('clientName').value.replace(/[^a-z0-9]/gi, '_') || 'Cliente';
            pdf.save(`Propuesta_${name}_2025.pdf`);
            btn.innerHTML = `GENERAR PDF OFICIAL`; btn.disabled = false;
        }

        window.onload = init;
    </script>
</body>
</html>